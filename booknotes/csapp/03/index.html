
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A blog about technical things, such as book notes and simple topics.">
      
      
        <meta name="author" content="Little Bee">
      
      
        <link rel="canonical" href="https://littlebee1024.github.io/learning_book/booknotes/csapp/03/">
      
      
        <link rel="prev" href="../02/">
      
      
        <link rel="next" href="../04/">
      
      
      <link rel="icon" href="../../../home/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>程序的机器表示 - Little Bee Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+Simplified+Chinese:300,300i,400,400i,700,700i%7CConsolas:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans Simplified Chinese";--md-code-font:"Consolas"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G2RFHH3DL4"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G2RFHH3DL4",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G2RFHH3DL4",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Little Bee Blog" class="md-header__button md-logo" aria-label="Little Bee Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.4 9C17 7.8 16.2 7 15 6.5V5h-1v1.4h-.4c-1.1 0-2 .4-2.8 1.2l-.4.4L9 7.5c-.3-.1-.6-.2-1-.2-.6 0-1.2.2-1.7.6-.6.4-.9.9-1.1 1.4-.2.7-.2 1.3 0 2 .3.7.6 1.2 1.1 1.5-.4 1.5-.1 2.8 1 3.9.8.8 1.7 1.2 2.8 1.2.5 0 .8 0 1.1-.1.6.8 1.4 1.3 2.4 1.3.3 0 .7 0 1-.1.6-.2 1-.6 1.4-1.1.4-.6.6-1.1.6-1.7 0-.4 0-.7-.1-1l-.5-1.6.6-.4c.8-.8 1.2-1.9 1.1-3.1H19V9zm-9.7 2.3c-.6-.3-.8-.7-.6-1.3q.3-.9 1.2-.6l3.2 1.2c-1.6.8-2.8 1-3.8.7m6.3 5.6c-.6.2-1 0-1.3-.6-.3-1-.1-2.2.7-3.8l1.2 3.1c.2.7 0 1.1-.6 1.3m1.2-5.3-.6-1.6v-.1l-.3-.3h-.1L12.6 9c.4-.3.8-.5 1.3-.5s1 .2 1.4.6.6.8.6 1.3c-.2.3-.4.8-.7 1.2"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Little Bee Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              程序的机器表示
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/littlebee1024/learning_book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    littlebee1024/learning_book
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../cxydzwxy/concurrency/" class="md-tabs__link">
          
  
  笔记

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../topics/webassembly/" class="md-tabs__link">
          
  
  专题

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../essays/20250127/" class="md-tabs__link">
          
  
  随笔

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Little Bee Blog" class="md-nav__button md-logo" aria-label="Little Bee Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.4 9C17 7.8 16.2 7 15 6.5V5h-1v1.4h-.4c-1.1 0-2 .4-2.8 1.2l-.4.4L9 7.5c-.3-.1-.6-.2-1-.2-.6 0-1.2.2-1.7.6-.6.4-.9.9-1.1 1.4-.2.7-.2 1.3 0 2 .3.7.6 1.2 1.1 1.5-.4 1.5-.1 2.8 1 3.9.8.8 1.7 1.2 2.8 1.2.5 0 .8 0 1.1-.1.6.8 1.4 1.3 2.4 1.3.3 0 .7 0 1-.1.6-.2 1-.6 1.4-1.1.4-.6.6-1.1.6-1.7 0-.4 0-.7-.1-1l-.5-1.6.6-.4c.8-.8 1.2-1.9 1.1-3.1H19V9zm-9.7 2.3c-.6-.3-.8-.7-.6-1.3q.3-.9 1.2-.6l3.2 1.2c-1.6.8-2.8 1-3.8.7m6.3 5.6c-.6.2-1 0-1.3-.6-.3-1-.1-2.2.7-3.8l1.2 3.1c.2.7 0 1.1-.6 1.3m1.2-5.3-.6-1.6v-.1l-.3-.3h-.1L12.6 9c.4-.3.8-.5 1.3-.5s1 .2 1.4.6.6.8.6 1.3c-.2.3-.4.8-.7 1.2"/></svg>

    </a>
    Little Bee Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/littlebee1024/learning_book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    littlebee1024/learning_book
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    笔记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            笔记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    程序员的自我修养
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            程序员的自我修养
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cxydzwxy/concurrency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    并发
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cxydzwxy/compile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    链接
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            链接
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cxydzwxy/link/static/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    静态链接
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cxydzwxy/link/dynamic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    动态链接
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cxydzwxy/load/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    装载
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Debug Hacks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Debug Hacks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug_hacks/basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调试前的必知必会
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug_hacks/advance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高级调试技术
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug_hacks/gdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug_hacks/dwarf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DWARF
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux高性能服务器编程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Linux高性能服务器编程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hplsp/tcp_ip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCP/IP协议
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hplsp/socket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    套接字基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hplsp/multi_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO复用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hplsp/adv_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高级IO函数
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux设备驱动程序
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Linux设备驱动程序
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ldd/module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内核模块
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ldd/cdev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    字符设备驱动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ldd/io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高级I/O操作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ldd/mem_port/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    与硬件通信
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    深入理解计算机系统
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            深入理解计算机系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算机漫游
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    信息的表示和处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    程序的机器表示
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    程序的机器表示
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      程序编码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      数据格式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      访问信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="访问信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      操作数指示符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      数据传送指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      压入和弹出栈数据
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      算术和逻辑操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="算术和逻辑操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      加载有效地址
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      常见的算术操作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      特殊的算术操作
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      条件码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      条件置位指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      条件跳转指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      条件传送指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      循环
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch" class="md-nav__link">
    <span class="md-ellipsis">
      switch语句
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      运行时栈
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      控制转移
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      数据传送
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      栈上的局部存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器中的局部存储空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      递归过程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      缓冲区溢出保护
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓冲区溢出保护">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      栈随机化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      栈破坏检测
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      限制可执行代码区域
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      数据对齐
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    处理器体系结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    优化程序性能
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    异常流控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟内存
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系统级I/O
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    机器学习
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            机器学习
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ml/linear_reg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线性回归
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ml/naive_bayes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    朴素贝叶斯法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ml/decision_tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    决策树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ml/perceptron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    感知机
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ml/svm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    支持向量机
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    高效C/C++调试
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            高效C/C++调试
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpp_debug/01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调试符号和调试器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpp_debug/02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    堆数据结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpp_debug/05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    优化后的二进制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cpp_debug/10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存调试工具
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    专题
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            专题
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/webassembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WebAssembly
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/cmake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CMake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vue3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Vue3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/vue/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vue3简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/vue/components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    组件复用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/vue/demo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    样例模板
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/flex_bison/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flex和Bison
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../topics/tcl_tk_in_c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tcl/Tk in C
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    随笔
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            随笔
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../essays/20250127/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    来自AI的开篇
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      程序编码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      数据格式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      访问信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="访问信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      操作数指示符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      数据传送指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      压入和弹出栈数据
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      算术和逻辑操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="算术和逻辑操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      加载有效地址
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      常见的算术操作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      特殊的算术操作
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      条件码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      条件置位指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      条件跳转指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      条件传送指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      循环
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch" class="md-nav__link">
    <span class="md-ellipsis">
      switch语句
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      运行时栈
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      控制转移
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      数据传送
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      栈上的局部存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器中的局部存储空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      递归过程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      缓冲区溢出保护
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓冲区溢出保护">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      栈随机化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      栈破坏检测
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      限制可执行代码区域
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      数据对齐
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  


<h1 id="_1">程序的机器表示<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<blockquote>
<p><a href="https://1drv.ms/b/s!AkcJSyT7tq80bJdqo_mT5IeFTsg?e=W297XG">《深入理解计算机系统》 - Randal E. Bryant - 第三版</a>，第三章的读书笔记，本文中的所有代码可在<a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code">GitHub仓库</a>中找到</p>
</blockquote>
<h2 id="_2">程序编码<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>机器代码将对C语言程序员隐藏的处理器状态都变为可见，如：</p>
<ul>
<li>程序计数器<ul>
<li>将要执行的下一条指令在内存中的地址，在x86-64中用<code>%rip</code>表示</li>
</ul>
</li>
<li>整数寄存器文件<ul>
<li>16个命名的位置，分别存储64位的值，用来记录程序状态，如过程参数，函数返回值等</li>
</ul>
</li>
<li>条件码寄存器<ul>
<li>保持最近执行的算术或逻辑指令的状态信息，用来实现<code>if</code>和<code>while</code>等语句</li>
</ul>
</li>
<li>一组向量寄存器<ul>
<li>存放一共或多个整数或浮点数值，用于向量运算</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/mstore">例子"mstore"</a>以<a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html"><code>-Og</code>编译器优化选项</a>，得到<code>multstore</code>对应的汇编代码如下：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">链接前的汇编代码</label><label for="__tabbed_1_2">链接后的汇编代码</label><label for="__tabbed_1_3">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># &quot;objdump -d mstore.o&quot;得到的反汇编信息</span>
<span class="c1"># void multstore(long x, long y, long *dest)</span>
<span class="c1"># x in %rdi, y in %rsi, dest in %rdx</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">multstore</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span>
<span class="w"> </span><span class="err">4:</span><span class="w">   </span><span class="err">53</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 保存 %rbx</span>
<span class="w"> </span><span class="err">5:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">d3</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rbx</span><span class="w">          </span><span class="c1"># 拷贝 dest 到 %rbx</span>
<span class="w"> </span><span class="err">8:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">d</span> <span class="p">&lt;</span><span class="no">multstore</span><span class="p">+</span><span class="mi">0xd</span><span class="p">&gt;</span><span class="w">  </span><span class="c1"># 调用子函数</span>
<span class="w"> </span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">03</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,(</span><span class="nv">%rbx</span><span class="p">)</span><span class="w">        </span><span class="c1"># 保存子函数返回值到 *dest</span>
<span class="err">10:</span><span class="w">   </span><span class="err">5</span><span class="nf">b</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 恢复 %rbx</span>
<span class="err">11:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w"> </span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># &quot;objdump -d main&quot;得到的反汇编信息</span>
<span class="err">00000000000011</span><span class="nf">d5</span><span class="w"> </span><span class="err">&lt;</span><span class="no">multstore</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w">    </span><span class="err">11</span><span class="nl">d5:</span><span class="w">       </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w">    </span><span class="mi">11</span><span class="no">d9</span><span class="p">:</span><span class="w">       </span><span class="mi">53</span><span class="w">                      </span><span class="no">push</span><span class="w">   </span><span class="nv">%rbx</span>
<span class="w">    </span><span class="err">11</span><span class="nl">da:</span><span class="w">       </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">d3</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rbx</span>
<span class="hll"><span class="w">    </span><span class="err">11</span><span class="nl">dd:</span><span class="w">       </span><span class="nf">e8</span><span class="w"> </span><span class="no">e7</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="no">ff</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">11c9</span> <span class="p">&lt;</span><span class="no">mult2</span><span class="p">&gt;</span>
</span><span class="w">    </span><span class="err">11</span><span class="nl">e2:</span><span class="w">       </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">03</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,(</span><span class="nv">%rbx</span><span class="p">)</span>
<span class="w">    </span><span class="err">11</span><span class="nl">e5:</span><span class="w">       </span><span class="err">5</span><span class="nf">b</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbx</span>
<span class="w">    </span><span class="err">11</span><span class="nl">e6:</span><span class="w">       </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">   </span>
<span class="w">    </span><span class="mi">11</span><span class="no">e7</span><span class="p">:</span><span class="w">       </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">f</span><span class="w"> </span><span class="mi">84</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">nopw</span><span class="w">   </span><span class="mi">0x0</span><span class="p">(</span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rax</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="err">11</span><span class="nl">ee:</span><span class="w">       </span><span class="err">00</span><span class="w"> </span><span class="err">00</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">multstore</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mult2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="_3">数据格式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>C声明</th>
<th>Intel数据类型</th>
<th>汇编代码后缀</th>
<th>大小(字节)</th>
</tr>
</thead>
<tbody>
<tr>
<td>char</td>
<td>字节</td>
<td>b</td>
<td>1</td>
</tr>
<tr>
<td>short</td>
<td>字</td>
<td>w</td>
<td>2</td>
</tr>
<tr>
<td>int</td>
<td>双字</td>
<td>l</td>
<td>4</td>
</tr>
<tr>
<td>long</td>
<td>四字</td>
<td>q</td>
<td>8</td>
</tr>
<tr>
<td>char*</td>
<td>四字</td>
<td>q</td>
<td>8</td>
</tr>
<tr>
<td>float</td>
<td>单精度</td>
<td>s</td>
<td>4</td>
</tr>
<tr>
<td>double</td>
<td>双精度</td>
<td>l</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>如上表所示，大多数GCC生成的汇编代码指令都有一个字符的后缀，表明操作数的大小。例如，数据传送指令有四个变种：</p>
<ul>
<li><code>movb</code>(传送字节，byte)</li>
<li><code>movw</code>(传送字，word)</li>
<li><code>movl</code>(传送双字，long word)</li>
<li><code>movq</code>(传送四字，quad word)。</li>
</ul>
<h2 id="_4">访问信息<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>一个x86-64的中央处理器包含一组16个存储64位值的<strong>通用目的寄存器</strong>。</p>
<ul>
<li>最初的8086中有8个16位的寄存器，即下图中的<code>%ax</code>到<code>%sp</code></li>
<li>扩展到IA32架构时，这些寄存器也扩展成64位，标号从<code>%eax</code>到<code>%esp</code></li>
<li>扩展到x86-64后，原来的8个寄存器扩展成64位，标号从<code>%rax</code>到<code>%rsp</code>，除此之外，还新增了8个寄存器，标号从<code>%r8</code>到<code>%r15</code></li>
</ul>
<p><img alt="registers_64bit" src="images/registers_64bit.png" /></p>
<p>指令可以对寄存器的低位字节中存放的不同大小的数据进行操作。当对寄存器部分字节进行操作时，其他字节遵循两条规则：</p>
<ul>
<li>操作1字节和2字节的指令会保存剩下的字节不变</li>
<li>操作4字节的指令会把高位4个字节置为0</li>
</ul>
<p>例如，下面的例子对不同字节位写入<code>-1</code>，会产生不同的结果：
<div class="highlight"><pre><span></span><code><span class="nf">movabsq</span><span class="w"> </span><span class="no">$0011223344556677</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># %rax = 0011223344556677</span>
<span class="nf">movb</span><span class="w">    </span><span class="no">$-1</span><span class="p">,</span><span class="w"> </span><span class="nv">%al</span><span class="w">                    </span><span class="c1"># %rax = 00112233445566FF</span>
<span class="nf">movw</span><span class="w">    </span><span class="no">$-1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ax</span><span class="w">                    </span><span class="c1"># %rax = 001122334455FFFF</span>
<span class="nf">movl</span><span class="w">    </span><span class="no">$-1</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">                   </span><span class="c1"># %rax = 00000000FFFFFFFF</span>
<span class="nf">movq</span><span class="w">    </span><span class="no">$-1</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">                   </span><span class="c1"># %rax = FFFFFFFFFFFFFFFF</span>
</code></pre></div></p>
<p>在常见的程序里，不同的寄存器扮演着不同的角色。例如，</p>
<ul>
<li><code>%rsp</code>始终指向栈顶</li>
<li><code>%rbp</code>指向当前栈开始的地方</li>
<li>函数调用时，前6个参数依次存放在以下寄存器中<ul>
<li><code>%rdi</code>，<code>%rsi</code>，<code>%rdx</code>，<code>%rcx</code>，<code>%r8</code>，<code>%r9</code></li>
</ul>
</li>
<li><code>%rax</code>用户存放函数的返回值</li>
</ul>
<p>更详细的介绍，可参考本文的<a href="#_7">"过程"</a>章节。</p>
<h3 id="_5">操作数指示符<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>x86-64支持多种操作数格式。源数据值可以是常数、或是寄存器或内存中的值。目的数据可以存放在寄存器或内存中。各种不同的操作数被分为三种类型：</p>
<ul>
<li>立即数<code>Imm</code></li>
<li>寄存器<code>R[ra]</code></li>
<li>内存引用<code>M[Imm]</code><ul>
<li>存在多种寻找方式</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>格式</th>
<th>操作数值</th>
<th>名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>立即数</td>
<td>$Imm</td>
<td>Imm</td>
<td>立即数寻址</td>
</tr>
<tr>
<td>寄存啊</td>
<td>ra</td>
<td>R[ra]</td>
<td>寄存器寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>Imm</td>
<td>M[Imm]</td>
<td>绝对寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>(ra)</td>
<td>M[R[ra]]</td>
<td>间接寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>Imm(rb)</td>
<td>M[Imm + R[rb]]</td>
<td>(基址+偏移量)寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>(rb,ri)</td>
<td>M[R[rb]+ R[ri]]</td>
<td>变址寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>Imm(rb,ri)</td>
<td>M[Imm + R[rb]+ R[ri]]</td>
<td>变址寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>(,ri,s)</td>
<td>M[R[ri] * s]</td>
<td>比例变址寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>Imm(,ri,s)</td>
<td>M[Imm + R[ri] * s]</td>
<td>比例变址寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>(rb,ri,s)</td>
<td>M[R[rb]+ R[ri] * s]</td>
<td>比例变址寻址</td>
</tr>
<tr>
<td>存储器</td>
<td>Imm(rb,ri,s)</td>
<td>M[Imm + R[rb]+ R[ri] * s]</td>
<td>比例变址寻址</td>
</tr>
</tbody>
</table>
<h3 id="_6">数据传送指令<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>mov S, D</td>
<td>把数据<code>S</code>传送给<code>D</code></td>
<td>movb, movw, movl, movq</td>
</tr>
<tr>
<td>movabsq I, R</td>
<td>把四字立即数存储在寄存器<code>R</code>中</td>
<td><code>movabsq $0011223344556677, %rax</code></td>
</tr>
<tr>
<td>movz S, R</td>
<td>把数据<code>S</code>存储在寄存器<code>R</code>中，高位用零补齐</td>
<td>movzbw, movzbl, movzwl, movzbq, movzwq</td>
</tr>
<tr>
<td>movs S, R</td>
<td>把数据<code>S</code>存储在寄存器<code>R</code>中，高位用符号位补齐</td>
<td>movsbw, movsbl, movswl, movsbq, movswq, movslq</td>
</tr>
<tr>
<td>cltq</td>
<td>把<code>%eax</code>符号扩展到<code>%rax</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>例如，下面的例子描述了不同传送指令的效果：
<div class="highlight"><pre><span></span><code><span class="nf">movabsq</span><span class="w"> </span><span class="no">$0011223344556677</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># %rax = 0011223344556677</span>
<span class="nf">movb</span><span class="w">    </span><span class="no">$0xAA</span><span class="p">,</span><span class="w"> </span><span class="nv">%dl</span><span class="w">                  </span><span class="c1"># %dl  = AA</span>
<span class="nf">movb</span><span class="w">    </span><span class="nv">%dl</span><span class="p">,</span><span class="w"> </span><span class="nv">%al</span><span class="w">                    </span><span class="c1"># %rax = 00112233445566AA</span>
<span class="nf">movsbq</span><span class="w">  </span><span class="no">$dl</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">                   </span><span class="c1"># %rax = FFFFFFFFFFFFFFAA</span>
<span class="nf">movzbq</span><span class="w">  </span><span class="no">$dl</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">                   </span><span class="c1"># %rax = 00000000000000AA</span>
</code></pre></div></p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_access/mov">例子"mov"</a>中的<code>exchange</code>函数利用了<code>mov</code>指令，修改了指针<code>xp</code>指向的内容：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">汇编代码</label><label for="__tabbed_2_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long exchange(long *xp, long y)</span>
<span class="c1"># xp in %rdi, y in %rsi</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">exchange</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span>
<span class="err">4:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">07</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdi</span><span class="p">),</span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># 从地址是 %rdi 的内存中获取值(*xp)，并传递到返回值 %rax 中</span>
<span class="err">7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">37</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,(</span><span class="nv">%rdi</span><span class="p">)</span><span class="w">     </span><span class="c1"># (*xp = y)</span>
<span class="nl">a:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">exchange</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">xp</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">xp</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">xp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_7">压入和弹出栈数据<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指令</th>
<th>效果</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>pushq S</td>
<td>R[%rsp] &lt;- R[%rsp] - 8; M[R[%rsp]] &lt;- S</td>
<td>将四字压入栈</td>
</tr>
<tr>
<td>popq D</td>
<td>D &lt;- M[R[%rsp]]; R[%rsp] &lt;- R[%rsp] + 8</td>
<td>将四字弹出栈</td>
</tr>
</tbody>
</table>
<p><code>pushq</code>和<code>popq</code>指令只有一个操作数 --- 压入的数据源和弹出的数据目的。</p>
<p>因为栈和程序代码都放在同以内存中，所以程序可以用标准的内存寻址方式访问栈内的任意位置。例如，假设栈顶元素是四字，指令<code>movq 8(%rsp), %rdx</code>会将第二个四字从栈中复制到寄存器<code>%rdx</code>中。</p>
<h2 id="_8">算术和逻辑操作<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>指令</th>
<th>效果</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>leaq S,R</td>
<td>R ← &amp;S</td>
<td>加载有效地址，目的地必须是寄存器</td>
</tr>
<tr>
<td>inc  D</td>
<td>D ← D+1</td>
<td>加1，可以是寄存器，也可以是一个内存位置</td>
</tr>
<tr>
<td>dec  D</td>
<td>D ← D−1</td>
<td>减1</td>
</tr>
<tr>
<td>neg  D</td>
<td>D ← -D</td>
<td>取负</td>
</tr>
<tr>
<td>not  D</td>
<td>D ← ~D</td>
<td>取补</td>
</tr>
<tr>
<td>add  S,D</td>
<td>D ← D + S</td>
<td>加，如果是写回内存的操作，第一个操作数必须是从内存读出</td>
</tr>
<tr>
<td>sub  S,D</td>
<td>D ← D − S</td>
<td>减</td>
</tr>
<tr>
<td>imul S,D</td>
<td>D ← D ∗ S</td>
<td>乘</td>
</tr>
<tr>
<td>xor  S,D</td>
<td>D ← D ^ S</td>
<td>异或</td>
</tr>
<tr>
<td>or   S,D</td>
<td>D ← D</td>
<td>S</td>
</tr>
<tr>
<td>and  S,D</td>
<td>D ← D &amp; S</td>
<td>与</td>
</tr>
<tr>
<td>sal  k,D</td>
<td>D ← D&lt;&lt;k</td>
<td>左移，移位量可以是立即数，或单字节寄存器<code>%cl</code></td>
</tr>
<tr>
<td>shl  k,D</td>
<td>D ← D&lt;&lt;k</td>
<td>左移 (等同SAL)</td>
</tr>
<tr>
<td>sar  k,D</td>
<td>D ← D&gt;&gt;k</td>
<td>算术右移</td>
</tr>
<tr>
<td>shr  k,D</td>
<td>D ← D&gt;&gt;k</td>
<td>逻辑右移</td>
</tr>
</tbody>
</table>
<h3 id="_9">加载有效地址<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>加载有效地址(load effective address)指令<code>leaq</code>实际上是<code>movq</code>指令的变形，将有效地址写入目的操作数（必须是寄存器）。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_operate/lea">例子"lea"</a>中的<code>scale</code>函数利用<code>leaq</code>指令，对<code>x + 4 * y + 12 * z</code>表达进行了求值：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">汇编代码</label><label for="__tabbed_3_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long scale(long x, long y, long z)</span>
<span class="c1"># x in %rdi, y in %rsi, z in %rdx</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">scale</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="no">d</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="no">b7</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rsi</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># x + 4*y</span>
<span class="w"> </span><span class="err">8:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">52</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="nv">%rdx</span><span class="w">    </span><span class="c1"># z + 2*z = 3*z</span>
<span class="w"> </span><span class="nl">c:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">90</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="p">(</span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># (x+4*y)+4*(3*z) = x + 4*y + 12*z</span>
<span class="err">10:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_10">常见的算术操作<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>如上表所视，常见的算术操作包括：加载有效地址、一元和二元操作、移位操作等。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_operate/arith">例子"arith"</a>中的<code>arith</code>函数对常见算术表达进行了求值：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">汇编代码</label><label for="__tabbed_4_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long arith(long x, long y, long z)</span>
<span class="c1"># x in %rdi, y in %rsi, z in %rdx</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">arith</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="no">f7</span><span class="w">                </span><span class="no">xor</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">              </span><span class="c1"># t1 = x ^ y</span>
<span class="w"> </span><span class="err">7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">52</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># 3*z</span>
<span class="w"> </span><span class="nl">b:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">c1</span><span class="w"> </span><span class="no">e0</span><span class="w"> </span><span class="mi">04</span><span class="w">             </span><span class="no">shl</span><span class="w">    </span><span class="no">$0x4</span><span class="p">,</span><span class="nv">%rax</span><span class="w">              </span><span class="c1"># t2 = 16 * (3*z) = 48*z</span>
<span class="w"> </span><span class="nl">f:</span><span class="w">   </span><span class="err">81</span><span class="w"> </span><span class="nf">e7</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w">       </span><span class="no">and</span><span class="w">    </span><span class="no">$0xf0f0f0f</span><span class="p">,</span><span class="nv">%edi</span><span class="w">        </span><span class="c1"># t3 = t1 &amp; 0x0F0F0F0F</span>
<span class="err">15:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">29</span><span class="w"> </span><span class="nf">f8</span><span class="w">                </span><span class="no">sub</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">              </span><span class="c1"># Return t2 - t3</span>
<span class="err">18:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">arith</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0F0F0F0F</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">t4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t3</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">t4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_11">特殊的算术操作<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指令</th>
<th>效果</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>imulq S</td>
<td>R[%rdx]:R[%rax] ← S × R[%rax]</td>
<td>有符号全乘法</td>
</tr>
<tr>
<td>mulq S</td>
<td>R[%rdx]:R[%rax] ← S × R[%rax]</td>
<td>无符号全乘法</td>
</tr>
<tr>
<td>cqto</td>
<td>R[%rdx]:R[%rax] ← 符号扩展(R[%rax])</td>
<td>转换为八字</td>
</tr>
<tr>
<td>idivq S</td>
<td>R[%rdx] ← R[%rdx]:R[%rax] mod S </br> R[%rax] ← R[%rdx]:R[%rax] ÷ S</td>
<td>有符号除法</td>
</tr>
<tr>
<td>divq S</td>
<td>R[%rdx] ← R[%rdx]:R[%rax] mod S </br> R[%rax] ← R[%rdx]:R[%rax] ÷ S</td>
<td>无符号除法</td>
</tr>
</tbody>
</table>
<p>两个64位有符号或无符号整数相乘得到的乘积需要128位来表示。上表描述的是支持产生两个64位数字的全128位乘积以及整数除法的指令。</p>
<p><code>imulq</code>指令有两种不同的形式：</p>
<ul>
<li>“双操作数”乘法指令<ul>
<li>从两个64位操作数产生一个64位乘积</li>
</ul>
</li>
<li>“单操作数”乘法指令<ul>
<li>计算两个64位值的全128位乘积</li>
<li>一个参数必须在寄存器<code>%rax</code>中，另一个参数作为指令的源操作数</li>
<li>乘积结果存放在<code>%rdx</code>(高64位)和<code>%rax</code>(低64位)中</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_operate/mul">例子"mul"</a>中的两个乘积函数分别利用了两种<code>imulq</code>指令，完成了乘法操作：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">“单操作数”乘法指令</label><label for="__tabbed_5_2">“双操作数”乘法指令</label><label for="__tabbed_5_3">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void multi_64(uint128_t *dest, uint64_t x, uint64_t y)</span>
<span class="c1"># dest in %rdi, x in %rsi, y in %rdx</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">multi_64</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">f0</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># x是第一个参数</span>
<span class="hll"><span class="w"> </span><span class="err">7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">f7</span><span class="w"> </span><span class="no">e2</span><span class="w">                </span><span class="no">mul</span><span class="w">    </span><span class="nv">%rdx</span><span class="w">           </span><span class="c1"># y是第二个参数，计算x*y，结果存放在 %rdx:%rax 中</span>
</span><span class="w"> </span><span class="nl">a:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">07</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,(</span><span class="nv">%rdi</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将低64位拷贝到 dest 低位地址</span>
<span class="w"> </span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">57</span><span class="w"> </span><span class="err">08</span><span class="w">             </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rdi</span><span class="p">)</span><span class="w"> </span><span class="c1"># 将高64位拷贝到 dest 高位地址</span>
<span class="err">11:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void multi_32(uint64_t *dest, uint32_t a, uint32_t b)</span>
<span class="c1"># dest in %rdi, a in %esi, b in %edx</span>
<span class="err">0000000000000012</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">multi_32</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">12:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="hll"><span class="mi">16</span><span class="p">:</span><span class="w">   </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="no">af</span><span class="w"> </span><span class="no">f2</span><span class="w">                </span><span class="no">imul</span><span class="w">   </span><span class="nv">%edx</span><span class="p">,</span><span class="nv">%esi</span><span class="w">      </span><span class="c1"># a*b, 结果存在 %rsi 中</span>
</span><span class="err">19:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">37</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,(</span><span class="nv">%rdi</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将结果存入 dest 中</span>
<span class="err">1</span><span class="nl">c:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">__int128</span><span class="w"> </span><span class="n">uint128_t</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">multi_64</span><span class="p">(</span><span class="n">uint128_t</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">uint128_t</span><span class="p">)</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">multi_32</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>除法或取模操作都是由“单操作数”除法指令完成的，其规则如下：</p>
<ul>
<li>寄存器<code>%rdx</code>(高64位)和<code>%rax</code>(低64位)中的128位数作为被除数，如果除数是一个64位的值<ul>
<li>无符号运算：<code>%rdx</code>应该设置为全0</li>
<li>有符号运算：<code>%rdx</code>应该设置为<code>%rax</code>的符号位，可以用指令<code>cqto</code>来完成</li>
</ul>
</li>
<li>除数作为指令的操作数给出</li>
<li>运算结果的商存储在寄存器<code>%rax</code>中，余数存储在寄存器<code>%rdx</code>中</li>
</ul>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_operate/div">例子"div"</a>利用除法指令完成了无符号数<code>uremdiv</code>和有符号数<code>remdiv</code>的除法操作：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">“单操作数”除法指令</label><label for="__tabbed_6_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void uremdiv(unsigned long x, unsigned long y, unsigned long *qp, unsigned long *rp)</span>
<span class="c1"># x in %rdi, y in %rsi, qp in %rdx, rp in %rcx</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">uremdiv</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">f8</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># 拷贝被除数 x 到 %rax</span>
<span class="w"> </span><span class="err">7:</span><span class="w">   </span><span class="err">49</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">d0</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%r8</span><span class="w">       </span><span class="c1"># 保存 qp 地址，以腾出 %rdx 用于除法操作</span>
<span class="w"> </span><span class="nl">a:</span><span class="w">   </span><span class="nf">ba</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x0</span><span class="p">,</span><span class="nv">%edx</span><span class="w">      </span><span class="c1"># 清零 %rdx</span>
<span class="hll"><span class="w"> </span><span class="nl">f:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">f7</span><span class="w"> </span><span class="no">f6</span><span class="w">                </span><span class="no">div</span><span class="w">    </span><span class="nv">%rsi</span><span class="w">           </span><span class="c1"># 执行除法操作，以 y 为除数</span>
</span><span class="err">12:</span><span class="w">   </span><span class="err">49</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">00</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,(</span><span class="nv">%r8</span><span class="p">)</span><span class="w">     </span><span class="c1"># 将商存入 *qp</span>
<span class="err">15:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">11</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,(</span><span class="nv">%rcx</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将余数存入 *rp</span>
<span class="err">18:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">   </span>

<span class="c1"># void remdiv(long x, long y, long *qp, long *rp)</span>
<span class="c1"># x in %rdi, y in %rsi, qp in %rdx, rp in %rcx</span>
<span class="err">0000000000000019</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">remdiv</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">19:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="mi">1</span><span class="no">d</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">f8</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># 拷贝被除数 x 到 %rax</span>
<span class="err">20:</span><span class="w">   </span><span class="err">49</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">d0</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%r8</span><span class="w">       </span><span class="c1"># 保存 qp 地址，以腾出 %rdx 用于除法操作</span>
<span class="hll"><span class="err">23:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">99</span><span class="w">                   </span><span class="nf">cqto</span><span class="w">                  </span><span class="c1"># 将 %rdx 设置为 %rax 的符号位</span>
</span><span class="hll"><span class="err">25:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">f7</span><span class="w"> </span><span class="no">fe</span><span class="w">                </span><span class="no">idiv</span><span class="w">   </span><span class="nv">%rsi</span><span class="w">           </span><span class="c1"># 执行除法操作，以 y 为除数</span>
</span><span class="err">28:</span><span class="w">   </span><span class="err">49</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">00</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,(</span><span class="nv">%r8</span><span class="p">)</span><span class="w">     </span><span class="c1"># 将商存入 *qp</span>
<span class="err">2</span><span class="nl">b:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">11</span><span class="w">                </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rdx</span><span class="p">,(</span><span class="nv">%rcx</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将余数存入 *rp</span>
<span class="err">2</span><span class="nl">e:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">uremdiv</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">qp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">qp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">remdiv</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">qp</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">qp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="_12">控制<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<h3 id="_13">条件码<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>除了前面描述的整数寄存器，CPU还维护着一组单个位的<strong>条件码寄存器</strong>，它们描述了<strong>最近</strong>的算术或逻辑操作的属性。最常见的条件码有：</p>
<ul>
<li>CF - 进位标志</li>
<li>ZF - 零标志</li>
<li>SF - 符号标志</li>
<li>OF - 溢出标志</li>
</ul>
<p>假如用<code>ADD</code>指令，完成表达式<code>t=a+b</code>的功能，会根据下面的表达式设置条件码：
<div class="highlight"><pre><span></span><code><span class="n">CF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">a</span><span class="w">      </span><span class="c1">// 无符号数发生溢出</span>
<span class="n">ZF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w">                         </span><span class="c1">// 零</span>
<span class="n">SF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w">                          </span><span class="c1">// 负数</span>
<span class="n">OF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w">   </span><span class="c1">// 有符号数发生溢出</span>
</code></pre></div></p>
<p>除了<code>leaq</code>指令不改变任何条件码外，其他指令都会设置条件码：</p>
<ul>
<li>对于逻辑操作，例如<code>XOR</code>，进位标志和溢出标志会设置成0</li>
<li>对于移位操作，进位标志将设置为最后一个被移出的位，而溢出标志设置为0</li>
<li><code>INC</code>和<code>DEC</code>指令会设置溢出和零标志</li>
</ul>
<p><code>CMP</code>指令和<code>TEST</code>指令，只设置条件码而不改变任何其他寄存器。它们的操作如下：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cmp S1, S2</td>
<td>比较(S2-S1)，根据两个操作数之差来设置条件码</td>
</tr>
<tr>
<td>test S1, S2</td>
<td>测试(S1&amp;S2)，用来指示哪些位应该被测试</td>
</tr>
</tbody>
</table>
<p>条件码的使用方式有三种：</p>
<ul>
<li>根据条件码的某种组合，将一个字节设置位0或者1，如<code>SET</code>指令</li>
<li>根据条件码跳转到程序的某个其他的部分，如<code>JMP</code>指令</li>
<li>根据条件码有条件的传送数，如<code>CMOV</code>指令</li>
</ul>
<h3 id="_14">条件置位指令<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>下表是常见的<code>SET</code>指令，每条指令根据条件码的组合，将一个字节设置位0或者1：</p>
<p><img alt="set" src="images/set.png" /></p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_control/cmp">例子"cmp"</a>通过<code>SET</code>指令和<code>CMP</code>指令，完成了两个数的比较过程：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">汇编代码</label><label for="__tabbed_7_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># int comp(long a, long b)</span>
<span class="c1"># a in %rdi, b in %rsi</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">comp</span><span class="err">&gt;</span><span class="no">a</span>
<span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="hll"><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="no">f7</span><span class="w">                </span><span class="no">cmp</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">   </span><span class="c1"># 比较 a-b</span>
</span><span class="hll"><span class="err">7:</span><span class="w">   </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="mi">9</span><span class="no">c</span><span class="w"> </span><span class="no">c0</span><span class="w">                </span><span class="no">setl</span><span class="w">   </span><span class="nv">%al</span><span class="w">         </span><span class="c1"># a&lt;b 时被置1</span>
</span><span class="nl">a:</span><span class="w">   </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="no">b6</span><span class="w"> </span><span class="no">c0</span><span class="w">                </span><span class="no">movzbl</span><span class="w"> </span><span class="nv">%al</span><span class="p">,</span><span class="nv">%eax</span><span class="w">    </span><span class="c1"># 将结果返回，高位被清零</span>
<span class="nl">d:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">comp</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_15">条件跳转指令<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>下表是常见的<code>JMP</code>指令，当跳转条件满足时，跳转到一条带标号的目的地：</p>
<ul>
<li>直接跳转<ul>
<li>跳转目标是作为指令的一部分编码，如：<code>jmp .L1</code></li>
</ul>
</li>
<li>间接跳转<ul>
<li>跳转目标是从寄存器或内存位置读出的，如：<code>jmp *%rax</code>，<code>jmp *(%rax)</code></li>
</ul>
</li>
</ul>
<p><img alt="jmp" src="images/jmp.png" /></p>
<p>C语言中的<code>if-else</code>语句在汇编代码中被转换为<code>goto</code>版本：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">汇编代码的"if-else"</label><label for="__tabbed_8_2">C语言的"if-else"</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nf">t</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">test-expr</span><span class="c1">;</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(!</span><span class="no">t</span><span class="p">)</span>
<span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">false</span><span class="c1">;</span>
<span class="nf">then-statement</span>
<span class="nf">goto</span><span class="w"> </span><span class="no">done</span><span class="c1">;</span>

<span class="nl">false:</span>
<span class="w">    </span><span class="nf">else-statement</span>
<span class="nl">done:</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test</span><span class="o">-</span><span class="n">expr</span><span class="p">)</span>
<span class="w">    </span><span class="n">then</span><span class="o">-</span><span class="n">statement</span>
<span class="k">else</span>
<span class="w">    </span><span class="k">else</span><span class="o">-</span><span class="n">statement</span>
</code></pre></div>
</div>
</div>
</div>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_control/jmp">例子"jmp"</a>通过<code>JMP</code>指令和<code>CMP</code>指令，实现了<code>if-else</code>条件分支：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:3"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><input id="__tabbed_9_3" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">汇编代码</label><label for="__tabbed_9_2">"if-else"版本C代码</label><label for="__tabbed_9_3">"goto"版本C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long absdiff(long x, long y)</span>
<span class="c1"># x in %rdi, y in %rsi</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">absdiff</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">f0</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rax</span>
<span class="hll"><span class="w"> </span><span class="err">7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">39</span><span class="w"> </span><span class="nf">f7</span><span class="w">                </span><span class="no">cmp</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">              </span><span class="c1"># 比较 x-y</span>
</span><span class="hll"><span class="w"> </span><span class="nl">a:</span><span class="w">   </span><span class="err">7</span><span class="nf">d</span><span class="w"> </span><span class="mi">0</span><span class="no">c</span><span class="w">                   </span><span class="no">jge</span><span class="w">    </span><span class="mh">18</span> <span class="p">&lt;</span><span class="no">absdiff</span><span class="p">+</span><span class="mi">0x18</span><span class="p">&gt;</span><span class="w">      </span><span class="c1"># x&gt;=y，跳转置0x18位置</span>
</span><span class="w"> </span><span class="nl">c:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="err">05</span><span class="w"> </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w">    </span><span class="nf">addq</span><span class="w">   </span><span class="no">$0x1</span><span class="p">,</span><span class="mi">0x0</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span><span class="w">         </span><span class="c1"># lt_cnt++</span>
<span class="err">13:</span><span class="w">   </span><span class="err">01</span><span class="w"> </span>
<span class="err">14:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">29</span><span class="w"> </span><span class="nf">f8</span><span class="w">                </span><span class="no">sub</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">              </span><span class="c1"># result = y - x</span>
<span class="err">17:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">   </span>
<span class="mi">18</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">addq</span><span class="w">   </span><span class="no">$0x1</span><span class="p">,</span><span class="mi">0x0</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span><span class="w">         </span><span class="c1"># ge_cnt++</span>
<span class="err">1</span><span class="nl">f:</span><span class="w">   </span><span class="err">01</span><span class="w"> </span>
<span class="err">20:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">29</span><span class="w"> </span><span class="nf">f7</span><span class="w">                </span><span class="no">sub</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">              </span><span class="c1"># x = x - y</span>
<span class="err">23:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">f8</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">              </span><span class="c1"># result = x</span>
<span class="err">26:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w"> </span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">absdiff</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">lt_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ge_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">gotodiff</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">x_ge_y</span><span class="p">;</span>
<span class="w">    </span><span class="n">lt_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="nl">x_ge_y</span><span class="p">:</span>
<span class="w">    </span><span class="n">ge_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_16">条件传送指令<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>下表是常见的<code>CMOV</code>指令，当传送条件满足时，指令把源值S复制到目的R：</p>
<p><img alt="comv" src="images/comv.png" /></p>
<p>和条件跳转不同，处理器无需预测测试的结果就可以执行条件传送，因此可以避免处理器因错误预测导致性能下降。</p>
<p>然而，不是所有的条件表达式都可以用条件传送来编译。以<code>v = test-expr ? then-expr : else-expr</code>语句为例子，用条件传送编译这个表达式会得到以下描述：</p>
<div class="highlight"><pre><span></span><code><span class="nf">v</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">then-expr</span><span class="c1">;</span>
<span class="nf">ve</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">else-expr</span><span class="c1">;</span>
<span class="nf">t</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">test-expr</span><span class="c1">;</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(!</span><span class="no">t</span><span class="p">)</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">ve</span><span class="c1">;</span>
</code></pre></div>
<p>条件传送的编译方式会同时对<code>then-expr</code>和<code>else-expr</code>求值。这和C语言的条件语句的执行过程是不一致的。</p>
<p>因此，条件传送只能用于非常受限制的情况，以提供代码运行的效率。<a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_control/cmov">例子"cmov"</a>只有开启了<code>-O1</code>优化选项，才能生成条件传送的汇编代码，默认情况下使用的是条件跳转指令：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">汇编代码</label><label for="__tabbed_10_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long cmovdiff(long x, long y)</span>
<span class="c1"># x in %rdi, y in %rsi</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">cmovdiff</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">f2</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdx</span>
<span class="w"> </span><span class="err">7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">29</span><span class="w"> </span><span class="nf">fa</span><span class="w">                </span><span class="no">sub</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rdx</span><span class="w">  </span><span class="c1"># y-x</span>
<span class="w"> </span><span class="nl">a:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">f8</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rax</span>
<span class="w"> </span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">29</span><span class="w"> </span><span class="nf">f0</span><span class="w">                </span><span class="no">sub</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rax</span><span class="w">  </span><span class="c1"># rval = x-y</span>
<span class="hll"><span class="err">10:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">39</span><span class="w"> </span><span class="nf">fe</span><span class="w">                </span><span class="no">cmp</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rsi</span><span class="w">  </span><span class="c1"># 比较 y-x</span>
</span><span class="hll"><span class="err">13:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="mi">4</span><span class="no">f</span><span class="w"> </span><span class="no">c2</span><span class="w">             </span><span class="no">cmovg</span><span class="w">  </span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rax</span><span class="w">  </span><span class="c1"># 如果 y&gt;x, rval = y-x</span>
</span><span class="err">17:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">  </span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">cmovdiff</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">rval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ntest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ntest</span><span class="p">)</span><span class="w"> </span><span class="n">rval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_17">循环<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>C语言提供了多种循环结构，即<code>do-while</code>、<code>while</code>和<code>for</code>。汇编中没有相应的指令存在，但可以用<strong>条件测试</strong>和<strong>跳转</strong>组合起来实现循环的效果。</p>
<ul>
<li>
<p><code>do-while</code>循环</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">汇编代码的"do-while"</label><label for="__tabbed_11_2">C语言的"do-while"</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nl">loop:</span>
<span class="w">    </span><span class="nf">body-statement</span>
<span class="w">    </span><span class="nf">t</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">test-expr</span><span class="c1">;</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="no">t</span><span class="p">)</span>
<span class="w">        </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="c1">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">do</span>
<span class="w">    </span><span class="n">body</span><span class="o">-</span><span class="n">statement</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">test</span><span class="o">-</span><span class="n">expr</span><span class="p">);</span>
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p><code>while</code>循环</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">汇编代码的"while"</label><label for="__tabbed_12_2">C语言的"while"</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">test</span><span class="c1">;</span>
<span class="nl">loop:</span>
<span class="w">    </span><span class="nf">body-statement</span>
<span class="nl">test:</span>
<span class="w">    </span><span class="nf">t</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">test-expr</span><span class="c1">;</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="no">t</span><span class="p">)</span>
<span class="w">        </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="c1">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="p">(</span><span class="n">test</span><span class="o">-</span><span class="n">expr</span><span class="p">)</span>
<span class="w">    </span><span class="n">body</span><span class="o">-</span><span class="n">statement</span>
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p><code>for</code>循环</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:2"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><input id="__tabbed_13_2" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">汇编代码的"for"</label><label for="__tabbed_13_2">C语言的"for"</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nf">init-expr</span><span class="c1">;</span>
<span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">test</span><span class="c1">;</span>
<span class="nl">loop:</span>
<span class="w">    </span><span class="nf">body-statement</span>
<span class="w">    </span><span class="nf">update-expr</span><span class="c1">;</span>
<span class="nl">test:</span>
<span class="w">    </span><span class="nf">t</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">test-expr</span><span class="c1">;</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="no">t</span><span class="p">)</span>
<span class="w">        </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="c1">;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">init</span><span class="o">-</span><span class="n">expr</span><span class="p">;</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">expr</span><span class="p">;</span><span class="w"> </span><span class="n">update</span><span class="o">-</span><span class="n">expr</span><span class="p">)</span>
<span class="w">    </span><span class="n">body</span><span class="o">-</span><span class="n">statement</span>
</code></pre></div>
</div>
</div>
</div>
</li>
</ul>
<h3 id="switch">switch语句<a class="headerlink" href="#switch" title="Permanent link">&para;</a></h3>
<p>switch语句的关键步骤是通过<strong>跳转表</strong>来访问代码位置。和使用一组很长的<code>if-else</code>语句相比，使用跳转表的有点是执行开关语句的时间与开关的数量无关。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/asm_control/switch">例子"switch"</a>编译出的<code>switch</code>语句的汇编代码，包含一个跳转表，类似<a href="code/asm_control/switch/switch.c">switch_impl.c</a>中的<code>goto</code>版本的C代码实现：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:3"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><input id="__tabbed_14_2" name="__tabbed_14" type="radio" /><input id="__tabbed_14_3" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">汇编代码</label><label for="__tabbed_14_2">switch语句</label><label for="__tabbed_14_3">"goto"版本的switch语句</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void switch_eg(long x, long n, long *dest)</span>
<span class="c1"># x in %rdi, n in %rsi, dest in %rdx</span>
<span class="nl">switch_eg:</span>
<span class="w">    </span><span class="nf">subq</span><span class="w">    </span><span class="no">$100</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span><span class="w">              </span><span class="c1"># index = n - 100</span>
<span class="w">    </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$6</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span><span class="w">                </span><span class="c1"># 比较 index-6</span>
<span class="w">    </span><span class="nf">ja</span><span class="w">      </span><span class="no">.L8</span><span class="w">                     </span><span class="c1"># 如果 index&gt;6, 跳转到 default 分支</span>
<span class="w">    </span><span class="nf">leaq</span><span class="w">    </span><span class="no">.L4</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span><span class="w"> </span><span class="nv">%rcx</span><span class="w">         </span><span class="c1"># 获取跳转表 .L4 起始地址</span>
<span class="w">    </span><span class="nf">movslq</span><span class="w">  </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%rsi</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># 获取跳转表中(index-6)位置的值，即需要跳转的地址相对偏移</span>
<span class="w">    </span><span class="nf">addq</span><span class="w">    </span><span class="nv">%rcx</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">              </span><span class="c1"># 计算出跳转地址</span>
<span class="w">    </span><span class="nf">notrack</span><span class="w"> </span><span class="no">jmp</span><span class="w"> </span><span class="p">*</span><span class="nv">%rax</span><span class="w">               </span><span class="c1"># 执行跳转</span>
<span class="nl">.L4:</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L7-.L4</span><span class="w">                </span><span class="c1"># Case 100: loc_A</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L8-.L4</span><span class="w">                </span><span class="c1"># Case 101: loc_def</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L6-.L4</span><span class="w">                </span><span class="c1"># Case 102: loc_B</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L5-.L4</span><span class="w">                </span><span class="c1"># Case 103: loc_C</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L3-.L4</span><span class="w">                </span><span class="c1"># Case 104: loc_D</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L8-.L4</span><span class="w">                </span><span class="c1"># Case 105: loc_def</span>
<span class="w">    </span><span class="na">.long</span><span class="w">    </span><span class="no">.L3-.L4</span><span class="w">                </span><span class="c1"># Case 106: loc_D</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">switch_eg</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">100</span><span class="p">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">102</span><span class="p">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">103</span><span class="p">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">104</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">106</span><span class="p">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">switch_eg_impl</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">jt</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="n">loc_A</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_def</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_B</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_C</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_D</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_def</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">loc_D</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">loc_def</span><span class="p">;</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="o">*</span><span class="n">jt</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

<span class="nl">loc_A</span><span class="p">:</span>
<span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="nl">loc_B</span><span class="p">:</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="nl">loc_C</span><span class="p">:</span>
<span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="nl">loc_D</span><span class="p">:</span>
<span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="nl">loc_def</span><span class="p">:</span>
<span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="nl">done</span><span class="p">:</span>
<span class="w">    </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="_18">过程<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h2>
<p>过程是软件中一种很重要的抽象。假设过程P调用过程Q，Q执行后返回到P。这个动作包括了：</p>
<ul>
<li>传递控制</li>
<li>传递数据</li>
<li>分配和释放内存</li>
</ul>
<h3 id="_19">运行时栈<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>下图给出来运行时栈的通用结构：</p>
<p><img alt="callstack" src="images/callstack.png" /></p>
<ul>
<li>P的栈帧<ul>
<li>通过寄存器，过程P可以传递最多6个整数值，如果Q需要更多的参数，P需要在调用Q之前在自己的栈帧里存储好这些参数</li>
<li>当过程P调用过程Q时，会把返回地址压入栈中，我们把这个返回地址当做P的栈帧的一部分，因为它存放的是与P相关的状态</li>
</ul>
</li>
<li>Q的栈帧<ul>
<li>Q的代码在过程的开始，会分配它的栈帧所需的空间<ul>
<li>大多数过程的栈帧都是定长的，但有些过程需要变长的帧，在x86-64中，常用帧指针<code>%rbp</code>帮助栈帧的管理</li>
</ul>
</li>
<li>在这个空间中，Q可以保存寄存器的值，分配局部变量空间，为其调用的过程设置参数</li>
</ul>
</li>
</ul>
<h3 id="_20">控制转移<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>call Label</td>
<td>过程调用</td>
</tr>
<tr>
<td>call *Operand</td>
<td>过程调用</td>
</tr>
<tr>
<td>ret</td>
<td>从过程调用中返回</td>
</tr>
</tbody>
</table>
<ul>
<li><code>call</code>指令会执行两个动作<ul>
<li>将返回地址压入栈中，此地址是紧跟在<code>call</code>指令后面的那条指令的地址</li>
<li>将PC寄存器设置为调用过程的起始地址</li>
</ul>
</li>
<li><code>ret</code>指令也会执行两个动作<ul>
<li>从栈中弹出返回地址</li>
<li>将PC寄存器设置为此返回地址</li>
</ul>
</li>
</ul>
<h3 id="_21">数据传送<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>操作数大小</th>
<th>参数1</th>
<th>参数2</th>
<th>参数3</th>
<th>参数4</th>
<th>参数5</th>
<th>参数6</th>
</tr>
</thead>
<tbody>
<tr>
<td>64</td>
<td>%rdi</td>
<td>%rsi</td>
<td>%rdx</td>
<td>%rcx</td>
<td>%r8</td>
<td>%r9</td>
</tr>
<tr>
<td>32</td>
<td>%edi</td>
<td>%esi</td>
<td>%edx</td>
<td>%ecx</td>
<td>%r8d</td>
<td>%r9d</td>
</tr>
<tr>
<td>16</td>
<td>%di</td>
<td>%si</td>
<td>%dx</td>
<td>%cx</td>
<td>%r8w</td>
<td>%r9w</td>
</tr>
<tr>
<td>8</td>
<td>%dil</td>
<td>%sil</td>
<td>%dl</td>
<td>%cl</td>
<td>%r8b</td>
<td>%r9b</td>
</tr>
</tbody>
</table>
<p>x86-64中，通过寄存器最多可以传递6个整型参数。如上表所示，根据参数的位数和在函数调用中位置，会分配不同的寄存器。如果一个函数有大于6个整型参数，超出部分就要通过栈来传递。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/proc_params">例子"proc_params"</a>中的<code>proc</code>函数有8个参数，且大小各不相同，通过观察其汇编代码，和上面的描述是一致的：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:2"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><input id="__tabbed_15_2" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">汇编代码</label><label for="__tabbed_15_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void proc(long a1, long *a1p, int a2, int *a2p, short a3, short *a3p, char a4, char *a4p)</span>
<span class="c1"># a1 in %rdi, a1p in %rsi</span>
<span class="c1"># a2 in %edx, a2p in %rcx</span>
<span class="c1"># a3 in %r8w, a3p in %r9</span>
<span class="c1"># a4 at %rsp+8, a4p at %rsp+16</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">proc</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="no">b</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># 将 a4p 存入 %rax</span>
<span class="w"> </span><span class="err">9:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">01</span><span class="w"> </span><span class="err">3</span><span class="nf">e</span><span class="w">                </span><span class="no">add</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,(</span><span class="nv">%rsi</span><span class="p">)</span><span class="w">        </span><span class="c1"># *a1p += a1 (64位)</span>
<span class="w"> </span><span class="nl">c:</span><span class="w">   </span><span class="err">01</span><span class="w"> </span><span class="err">11</span><span class="w">                   </span><span class="nf">add</span><span class="w">    </span><span class="nv">%edx</span><span class="p">,(</span><span class="nv">%rcx</span><span class="p">)</span><span class="w">        </span><span class="c1"># *a2p += a2 (32位)</span>
<span class="w"> </span><span class="nl">e:</span><span class="w">   </span><span class="err">66</span><span class="w"> </span><span class="err">45</span><span class="w"> </span><span class="err">01</span><span class="w"> </span><span class="err">01</span><span class="w">             </span><span class="nf">add</span><span class="w">    </span><span class="nv">%r8w</span><span class="p">,(</span><span class="nv">%r9</span><span class="p">)</span><span class="w">         </span><span class="c1"># *a3p += a3 (16位)</span>
<span class="err">12:</span><span class="w">   </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">08</span><span class="w">             </span><span class="no">mov</span><span class="w">    </span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%edx</span><span class="w">     </span><span class="c1"># 将 a4 存入 %edx (8位)</span>
<span class="err">16:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span><span class="err">10</span><span class="w">                   </span><span class="nf">add</span><span class="w">    </span><span class="nv">%dl</span><span class="p">,(</span><span class="nv">%rax</span><span class="p">)</span><span class="w">         </span><span class="c1"># *a4p += a4 (8位)</span>
<span class="err">18:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">proc</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">a1p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a2p</span><span class="p">,</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">a3</span><span class="p">,</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="o">*</span><span class="n">a3p</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">a4</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">a4p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">a1p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a1</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">a2p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a2</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">a3p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a3</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">a4p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_22">栈上的局部存储<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>大多数情况下过程中的局部数据可存放在寄存器中，但有些情况下，局部数据必须存放在内存中：</p>
<ul>
<li>寄存器不足够存放所有的本地数据</li>
<li>对一个局部变量使用了地址运算符<code>&amp;</code>，需要产生一个地址</li>
<li>局部变量是数组或结构</li>
</ul>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/proc_params">例子"proc_params"</a>中的<code>call_proc</code>函数必须在栈上分配局部变量，以产生局部变量的地址，传入<code>proc</code>函数：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">汇编代码</label><label for="__tabbed_16_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long call_proc()</span>
<span class="c1">#   proc(x1, &amp;x1, x2, &amp;x2, x3, &amp;x3, x4, &amp;x4)</span>
<span class="err">0000000000000019</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">call_proc</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">19:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="mi">1</span><span class="no">d</span><span class="p">:</span><span class="w">   </span><span class="mi">53</span><span class="w">                      </span><span class="no">push</span><span class="w">   </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 保存 %rbx 寄存器</span>
<span class="err">1</span><span class="nl">e:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">20</span><span class="w">             </span><span class="no">sub</span><span class="w">    </span><span class="no">$0x20</span><span class="p">,</span><span class="nv">%rsp</span><span class="w">         </span><span class="c1"># 在栈上分配32字节空间</span>
<span class="err">22:</span><span class="w">   </span><span class="nf">bb</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x28</span><span class="p">,</span><span class="nv">%ebx</span>
<span class="err">27:</span><span class="w">   </span><span class="err">64</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">03</span><span class="w">             </span><span class="no">mov</span><span class="w">    </span><span class="nv">%fs</span><span class="p">:(</span><span class="nv">%rbx</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># 获取金丝雀值，用于保护栈溢出，详情参见后面的章节</span>
<span class="err">2</span><span class="nl">b:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">44</span><span class="w"> </span><span class="err">24</span><span class="w"> </span><span class="err">18</span><span class="w">          </span><span class="nf">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span><span class="w">    </span><span class="c1"># 在栈(%rsp+24)存入8字节的金丝雀值</span>
<span class="err">30:</span><span class="w">   </span><span class="err">31</span><span class="w"> </span><span class="nf">c0</span><span class="w">                   </span><span class="no">xor</span><span class="w">    </span><span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span><span class="w">          </span><span class="c1"># 置零 %rax</span>
<span class="err">32:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">c7</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">movq</span><span class="w">   </span><span class="no">$0x1</span><span class="p">,</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span><span class="w">    </span><span class="c1"># 在栈(%rsp+16)存入8字节的x1</span>
<span class="err">39:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w"> </span>
<span class="err">3</span><span class="nl">b:</span><span class="w">   </span><span class="nf">c7</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">0</span><span class="no">c</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">movl</span><span class="w">   </span><span class="no">$0x2</span><span class="p">,</span><span class="mi">0xc</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span><span class="w">     </span><span class="c1"># 在栈(%rsp+12)存入4字节的x2</span>
<span class="err">42:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span>
<span class="err">43:</span><span class="w">   </span><span class="err">66</span><span class="w"> </span><span class="nf">c7</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">0</span><span class="no">a</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">movw</span><span class="w">   </span><span class="no">$0x3</span><span class="p">,</span><span class="mi">0xa</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span><span class="w">     </span><span class="c1"># 在栈(%rsp+10)存入2字节的x3</span>
<span class="err">4</span><span class="nl">a:</span><span class="w">   </span><span class="nf">c6</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">09</span><span class="w"> </span><span class="mi">04</span><span class="w">          </span><span class="no">movb</span><span class="w">   </span><span class="no">$0x4</span><span class="p">,</span><span class="mi">0x9</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span><span class="w">     </span><span class="c1"># 在栈(%rsp+9)存入1字节的x4</span>
<span class="err">4</span><span class="nl">f:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">4</span><span class="no">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">0</span><span class="no">c</span><span class="w">          </span><span class="no">lea</span><span class="w">    </span><span class="mi">0xc</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rcx</span><span class="w">     </span><span class="c1"># 参数4寄存器 %rcx 存入&amp;x2</span>
<span class="err">54:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">lea</span><span class="w">    </span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rsi</span><span class="w">    </span><span class="c1"># 参数2寄存器 %rsi 存入&amp;x1</span>
<span class="err">59:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">09</span><span class="w">          </span><span class="no">lea</span><span class="w">    </span><span class="mi">0x9</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rax</span><span class="w">     </span><span class="c1"># &amp;x4 通过 %rax 入栈</span>
<span class="err">5</span><span class="nl">e:</span><span class="w">   </span><span class="err">50</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="nv">%rax</span><span class="w">               </span><span class="c1"># 入栈&amp;x4，用于参数8，栈顶下移8字节</span>
<span class="err">5</span><span class="nl">f:</span><span class="w">   </span><span class="err">6</span><span class="nf">a</span><span class="w"> </span><span class="mi">04</span><span class="w">                   </span><span class="no">pushq</span><span class="w">  </span><span class="no">$0x4</span><span class="w">               </span><span class="c1"># 入栈x4，用于参数7，栈顶下移8字节</span>
<span class="err">61:</span><span class="w">   </span><span class="err">4</span><span class="nf">c</span><span class="w"> </span><span class="mi">8</span><span class="no">d</span><span class="w"> </span><span class="mi">4</span><span class="no">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="no">a</span><span class="w">          </span><span class="no">lea</span><span class="w">    </span><span class="mi">0x1a</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%r9</span><span class="w">     </span><span class="c1"># 参数6寄存器 %r9 存入&amp;x3，&amp;x3地址因栈顶变化需要更新</span>
<span class="err">66:</span><span class="w">   </span><span class="err">41</span><span class="w"> </span><span class="nf">b8</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x3</span><span class="p">,</span><span class="nv">%r8d</span><span class="w">          </span><span class="c1"># 参数5寄存器 %r8d 存入x3</span>
<span class="err">6</span><span class="nl">c:</span><span class="w">   </span><span class="nf">ba</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x2</span><span class="p">,</span><span class="nv">%edx</span><span class="w">          </span><span class="c1"># 参数3寄存器 %edx 存入x2</span>
<span class="err">71:</span><span class="w">   </span><span class="nf">bf</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x1</span><span class="p">,</span><span class="nv">%edi</span><span class="w">          </span><span class="c1"># 参数1寄存器 %edi 存入x1</span>
<span class="err">76:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">7b</span> <span class="p">&lt;</span><span class="no">call_proc</span><span class="p">+</span><span class="mi">0x62</span><span class="p">&gt;</span><span class="c1"># 调用 proc 函数</span>
<span class="err">7</span><span class="nl">b:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">63</span><span class="w"> </span><span class="err">4</span><span class="nf">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="no">c</span><span class="w">          </span><span class="no">movslq</span><span class="w"> </span><span class="mi">0x1c</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rcx</span><span class="w">    </span><span class="c1"># 将x2存入 %rcx, 函数调用前后栈顶位置不变</span>
<span class="err">80:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">03</span><span class="w"> </span><span class="err">4</span><span class="nf">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">20</span><span class="w">          </span><span class="no">add</span><span class="w">    </span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rcx</span><span class="w">    </span><span class="c1"># x1+x2</span>
<span class="err">85:</span><span class="w">   </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="no">bf</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">1</span><span class="no">a</span><span class="w">          </span><span class="no">movswl</span><span class="w"> </span><span class="mi">0x1a</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%edx</span><span class="w">    </span><span class="c1"># 将x3存入 %edx</span>
<span class="err">8</span><span class="nl">a:</span><span class="w">   </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="no">be</span><span class="w"> </span><span class="mi">44</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">19</span><span class="w">          </span><span class="no">movsbl</span><span class="w"> </span><span class="mi">0x19</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%eax</span><span class="w">    </span><span class="c1"># 将x4存入 %eax</span>
<span class="err">8</span><span class="nl">f:</span><span class="w">   </span><span class="err">29</span><span class="w"> </span><span class="nf">c2</span><span class="w">                   </span><span class="no">sub</span><span class="w">    </span><span class="nv">%eax</span><span class="p">,</span><span class="nv">%edx</span><span class="w">          </span><span class="c1"># x3-x4</span>
<span class="err">91:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">63</span><span class="w"> </span><span class="nf">c2</span><span class="w">                </span><span class="no">movslq</span><span class="w"> </span><span class="nv">%edx</span><span class="p">,</span><span class="nv">%rax</span>
<span class="err">94:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="no">af</span><span class="w"> </span><span class="no">c1</span><span class="w">             </span><span class="no">imul</span><span class="w">   </span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%rax</span><span class="w">          </span><span class="c1"># (x1+x2)*(x3-x4)</span>
<span class="err">98:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">c4</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="no">add</span><span class="w">    </span><span class="no">$0x10</span><span class="p">,</span><span class="nv">%rsp</span><span class="w">         </span><span class="c1"># 释放 call_proc 参数在栈上的空间</span>
<span class="err">9</span><span class="nl">c:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">7</span><span class="no">c</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">18</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span><span class="nv">%rdi</span>
<span class="nl">a1:</span><span class="w">   </span><span class="err">64</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">33</span><span class="w"> </span><span class="err">3</span><span class="nf">b</span><span class="w">             </span><span class="no">xor</span><span class="w">    </span><span class="nv">%fs</span><span class="p">:(</span><span class="nv">%rbx</span><span class="p">),</span><span class="nv">%rdi</span><span class="w">    </span><span class="c1"># 检查金丝雀值，确保栈没有被破坏</span>
<span class="nl">a5:</span><span class="w">   </span><span class="err">75</span><span class="w"> </span><span class="err">06</span><span class="w">                   </span><span class="nf">jne</span><span class="w">    </span><span class="mh">ad</span> <span class="p">&lt;</span><span class="no">call_proc</span><span class="p">+</span><span class="mi">0x94</span><span class="p">&gt;</span>
<span class="nl">a7:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">c4</span><span class="w"> </span><span class="mi">20</span><span class="w">             </span><span class="no">add</span><span class="w">    </span><span class="no">$0x20</span><span class="p">,</span><span class="nv">%rsp</span><span class="w">         </span><span class="c1"># 释放 proc 的栈空间</span>
<span class="nl">ab:</span><span class="w">   </span><span class="err">5</span><span class="nf">b</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 恢复 %rbx 寄存器</span>
<span class="nl">ac:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">                      </span><span class="c1"># 返回</span>
<span class="nl">ad:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">b2</span> <span class="p">&lt;</span><span class="no">call_proc</span><span class="p">+</span><span class="mi">0x99</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">call_proc</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">short</span><span class="w"> </span><span class="n">x3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">x4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">proc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x4</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x3</span><span class="o">-</span><span class="n">x4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>下图展示了<code>call_proc</code>函数的栈帧内容，其中“金丝雀”用于检验栈是否被破坏，详情可参见<a href="#_27">"栈破坏检测"</a>章节。</p>
<p><img alt="callstack_proc" src="images/callstack_proc.png" /></p>
<h3 id="_23">寄存器中的局部存储空间<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>根据惯例，寄存器<code>%rbx</code>、<code>%rbp</code>和<code>%r12~%r15</code>为<strong>被调用这保存</strong>寄存器。所有其他的寄存器，除了栈指针<code>%rsp</code>，都为<strong>调用者保存</strong>寄存器，任何函数都能修改他们。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/proc_reg_save">例子"proc_reg_save"</a>中的<code>P</code>函数在两次调用<code>Q</code>函数的过程中，利用<strong>被调用这保存</strong>寄存器<code>%rbx</code>和<code>%rbp</code>保存了局部变量，因此需要在调用结束时恢复寄存器<code>%rbx</code>和<code>%rbp</code>原来的值：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><input id="__tabbed_17_2" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="__tabbed_17_1">汇编代码</label><label for="__tabbed_17_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long P(long x, long y)</span>
<span class="c1"># x in %rdi, y in %rsi</span>
<span class="err">0000000000000009</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">P</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">9:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="no">d</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="no">push</span><span class="w">   </span><span class="nv">%rbp</span><span class="w">           </span><span class="c1"># 保存 %rbp</span>
<span class="w"> </span><span class="nl">e:</span><span class="w">   </span><span class="err">53</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="nv">%rbx</span><span class="w">           </span><span class="c1"># 保存 %rbx</span>
<span class="w"> </span><span class="nl">f:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">fd</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rbp</span><span class="w">      </span><span class="c1"># 保存x到 %rbp</span>
<span class="err">12:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">f7</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">      </span><span class="c1"># 保存y到参数1寄存器 %rdi</span>
<span class="err">15:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">1a</span> <span class="p">&lt;</span><span class="no">P</span><span class="p">+</span><span class="mi">0x11</span><span class="p">&gt;</span><span class="w">    </span><span class="c1"># 调用 Q(y)</span>
<span class="err">1</span><span class="nl">a:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">c3</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rbx</span><span class="w">      </span><span class="c1"># 保存Q(y)的返回值</span>
<span class="err">1</span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">ef</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rbp</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">      </span><span class="c1"># 保存x到参数1寄存器 %rdi</span>
<span class="err">20:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">25</span> <span class="p">&lt;</span><span class="no">P</span><span class="p">+</span><span class="mi">0x1c</span><span class="p">&gt;</span><span class="w">    </span><span class="c1"># 调用 Q(x)</span>
<span class="err">25:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">01</span><span class="w"> </span><span class="nf">d8</span><span class="w">                </span><span class="no">add</span><span class="w">    </span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># 将Q(y)的返回值，加到Q(x)的返回值上</span>
<span class="err">28:</span><span class="w">   </span><span class="err">5</span><span class="nf">b</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbx</span><span class="w">           </span><span class="c1"># 恢复 %rbx</span>
<span class="err">29:</span><span class="w">   </span><span class="err">5</span><span class="nf">d</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbp</span><span class="w">           </span><span class="c1"># 恢复 %rbp</span>
<span class="err">2</span><span class="nl">a:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">P</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_24">递归过程<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/proc_reg_save">例子"proc_reg_save"</a>使用寄存器<code>%rbx</code>来保存参数n，先把已有的值保存在栈上，在返回前恢复该值。因此，递归深度越深，所需要的栈空间就越大。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><input id="__tabbed_18_2" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="__tabbed_18_1">汇编代码</label><label for="__tabbed_18_2">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># long rfact(long n)</span>
<span class="c1"># n in %rdi</span>
<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">rfact</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w"> </span><span class="err">0:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="mi">01</span><span class="w">             </span><span class="no">cmp</span><span class="w">    </span><span class="no">$0x1</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">          </span><span class="c1"># 比较 n-1</span>
<span class="w"> </span><span class="err">8:</span><span class="w">   </span><span class="err">7</span><span class="nf">f</span><span class="w"> </span><span class="mi">06</span><span class="w">                   </span><span class="no">jg</span><span class="w">     </span><span class="mh">10</span> <span class="p">&lt;</span><span class="no">rfact</span><span class="p">+</span><span class="mi">0x10</span><span class="p">&gt;</span><span class="w">    </span><span class="c1"># 如果n&gt;1，跳转至0x10行</span>
<span class="w"> </span><span class="nl">a:</span><span class="w">   </span><span class="nf">b8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">mov</span><span class="w">    </span><span class="no">$0x1</span><span class="p">,</span><span class="nv">%eax</span><span class="w">          </span><span class="c1"># 如果n&lt;=1，返回1</span>
<span class="w"> </span><span class="nl">f:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span>
<span class="err">10:</span><span class="w">   </span><span class="err">53</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 入栈保存 %rbx</span>
<span class="err">11:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">fb</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rbx</span><span class="w">          </span><span class="c1"># 把 n 存入 %rbx</span>
<span class="err">14:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">7</span><span class="no">f</span><span class="w"> </span><span class="no">ff</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="mi">-0</span><span class="no">x1</span><span class="p">(</span><span class="nv">%rdi</span><span class="p">),</span><span class="nv">%rdi</span><span class="w">    </span><span class="c1"># 把 n-1 存入参数1寄存器 %rdi</span>
<span class="err">18:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">1d</span> <span class="p">&lt;</span><span class="no">rfact</span><span class="p">+</span><span class="mi">0x1d</span><span class="p">&gt;</span><span class="w">    </span><span class="c1"># 调用 rfact(n-1)</span>
<span class="err">1</span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">0</span><span class="nf">f</span><span class="w"> </span><span class="no">af</span><span class="w"> </span><span class="no">c3</span><span class="w">             </span><span class="no">imul</span><span class="w">   </span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="w">          </span><span class="c1"># 将调用结果乘以 n</span>
<span class="err">21:</span><span class="w">   </span><span class="err">5</span><span class="nf">b</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="nv">%rbx</span><span class="w">               </span><span class="c1"># 恢复 %rbx</span>
<span class="err">22:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w">                      </span><span class="c1"># 返回</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">long</span><span class="w"> </span><span class="nf">rfact</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rfact</span><span class="p">(</span><span class="n">n</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="_25">缓冲区溢出保护<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<p>局部变量和状态信息都存放在栈中，C对于数组引用不进行任何边界检查，因此对数组的越界写操作会破坏栈中的状态信息。一种常见的状态破坏称为<strong>缓冲区溢出</strong>。现代编译器和操作系统实现了很多机制，限制入侵者通过缓冲区溢出攻击。</p>
<h3 id="_26">栈随机化<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>栈随机化的思想，利用了地址空间布局随机化(Address-Space Layout Randomization, ASLR)技术，使得栈的位置在程序每次运行时都有变化。因此，限制了对某一固定地址的攻击。其实现方式时：程序开始时，在栈上分配一段0~n字节之间的随机大小的空间。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/protect_ASLR">例子"protect_ASLR"</a>每次运行，都会打印不同的地址值。当然，如果利用<code>setarch `uname -m` -R ./main</code>，禁止ASLR功能，则每次打印的结构会变得一样。</p>
<p><div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">long</span><span class="w"> </span><span class="n">local</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;local at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&gt;<span class="w"> </span>./main
<span class="nb">local</span><span class="w"> </span>at<span class="w"> </span>0x7ffda1b6c530
&gt;<span class="w"> </span>./main
<span class="nb">local</span><span class="w"> </span>at<span class="w"> </span>0x7ffded86af10

<span class="c1"># 禁止ASLR运行程序</span>
&gt;<span class="w"> </span>setarch<span class="w"> </span><span class="sb">`</span>uname<span class="w"> </span>-m<span class="sb">`</span><span class="w"> </span>-R<span class="w"> </span>./main
<span class="nb">local</span><span class="w"> </span>at<span class="w"> </span>0x7fffffffdf10
&gt;<span class="w"> </span>setarch<span class="w"> </span><span class="sb">`</span>uname<span class="w"> </span>-m<span class="sb">`</span><span class="w"> </span>-R<span class="w"> </span>./main
<span class="nb">local</span><span class="w"> </span>at<span class="w"> </span>0x7fffffffdf10
</code></pre></div></p>
<h3 id="_27">栈破坏检测<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>栈破坏检测能够检测到何时栈已经被破坏。其思想是在栈帧中任何局部缓冲区与栈状态之间存储一个特殊的<strong>金丝雀</strong>值(canary)，也称<strong>哨兵</strong>值(guard value)，是在程序每次运行时随机产生的。在恢复寄存器状态和从函数返回之前，程序检查这个金丝雀值是否被该函数的某个操作或者该函数调用的某个函数的某个操作改变了。如果是的，那么程序异常中止。</p>
<p>金丝雀值是通过指令参数<code>%fs:40</code>，用<strong>段寻址</strong>(segmented addressiong)从内存中读入的。将金丝雀值存放在一个特殊的段中，标志为“只读”，这样攻击者就不能覆盖存储的金丝雀值。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/protect_canary">例子"protect_canary"</a>默认情况下能产生拥有栈破坏检查的代码，利用<code>-fno-stack-protector</code>选项，也可以产生没有金丝雀值的代码：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:3"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><input id="__tabbed_19_2" name="__tabbed_19" type="radio" /><input id="__tabbed_19_3" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="__tabbed_19_1">有"金丝雀"值的汇编代码</label><label for="__tabbed_19_2">没有"金丝雀"值的汇编代码</label><label for="__tabbed_19_3">C代码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void bar()</span>
<span class="c1">#   foo(&amp;x);</span>
<span class="c1">#   &amp;x in %rdi</span>
<span class="err">0000000000000021</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">bar</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">21:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="mi">25</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="no">push</span><span class="w">   </span><span class="nv">%rbp</span><span class="w">               </span><span class="c1"># 入栈保存 %rbp</span>
<span class="err">26:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="nv">%rbp</span><span class="w">          </span><span class="c1"># 设置帧指针 %rbp</span>
<span class="err">29:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="no">sub</span><span class="w">    </span><span class="no">$0x10</span><span class="p">,</span><span class="nv">%rsp</span><span class="w">         </span><span class="c1"># 分配16字节栈空间</span>
<span class="err">2</span><span class="nl">d:</span><span class="w">   </span><span class="err">64</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">mov</span><span class="w">    </span><span class="nv">%fs</span><span class="p">:</span><span class="mi">0x28</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># 获取金丝雀值</span>
<span class="err">34:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w"> </span>
<span class="err">36:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="err">45</span><span class="w"> </span><span class="nf">f8</span><span class="w">             </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将8字节金丝雀值写入栈</span>
<span class="err">3</span><span class="nl">a:</span><span class="w">   </span><span class="err">31</span><span class="w"> </span><span class="nf">c0</span><span class="w">                   </span><span class="no">xor</span><span class="w">    </span><span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>
<span class="err">3</span><span class="nl">c:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">c7</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">f0</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">movq</span><span class="w">   </span><span class="no">$0x1</span><span class="p">,-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span><span class="w">   </span><span class="c1"># 将8字节x值写入栈</span>
<span class="err">43:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span>
<span class="err">44:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">f0</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="mi">-0</span><span class="no">x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span><span class="nv">%rax</span><span class="w">   </span><span class="c1"># &amp;x</span>
<span class="err">48:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">c7</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">          </span><span class="c1"># 设置foo函数参数1为&amp;x</span>
<span class="err">4</span><span class="nl">b:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">50</span> <span class="p">&lt;</span><span class="no">bar</span><span class="p">+</span><span class="mi">0x2f</span><span class="p">&gt;</span><span class="w">      </span><span class="c1"># 调用foo(&amp;x)</span>
<span class="err">50:</span><span class="w">   </span><span class="err">90</span><span class="w">                      </span><span class="nf">nop</span>
<span class="err">51:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">b</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">f8</span><span class="w">             </span><span class="no">mov</span><span class="w">    </span><span class="mi">-0</span><span class="no">x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># 获取栈上的金丝雀值</span>
<span class="err">55:</span><span class="w">   </span><span class="err">64</span><span class="w"> </span><span class="err">48</span><span class="w"> </span><span class="err">33</span><span class="w"> </span><span class="err">04</span><span class="w"> </span><span class="err">25</span><span class="w"> </span><span class="err">28</span><span class="w"> </span><span class="err">00</span><span class="w">    </span><span class="nf">xor</span><span class="w">    </span><span class="nv">%fs</span><span class="p">:</span><span class="mi">0x28</span><span class="p">,</span><span class="nv">%rax</span><span class="w">      </span><span class="c1"># 检测金丝雀值是否正确</span>
<span class="err">5</span><span class="nl">c:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span><span class="err">00</span><span class="w"> </span>
<span class="err">5</span><span class="nl">e:</span><span class="w">   </span><span class="err">74</span><span class="w"> </span><span class="err">05</span><span class="w">                   </span><span class="nf">je</span><span class="w">     </span><span class="mh">65</span> <span class="p">&lt;</span><span class="no">bar</span><span class="p">+</span><span class="mi">0x44</span><span class="p">&gt;</span>
<span class="err">60:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">65</span> <span class="p">&lt;</span><span class="no">bar</span><span class="p">+</span><span class="mi">0x44</span><span class="p">&gt;</span>
<span class="err">65:</span><span class="w">   </span><span class="nf">c9</span><span class="w">                      </span><span class="no">leaveq</span><span class="w"> </span>
<span class="mi">66</span><span class="p">:</span><span class="w">   </span><span class="no">c3</span><span class="w">                      </span><span class="no">retq</span><span class="w"> </span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># void bar()</span>
<span class="c1">#   foo(&amp;x);</span>
<span class="c1">#   &amp;x in %rdi</span>
<span class="err">0000000000000021</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">bar</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">21:</span><span class="w">   </span><span class="nf">f3</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">1</span><span class="no">e</span><span class="w"> </span><span class="no">fa</span><span class="w">             </span><span class="no">endbr64</span><span class="w"> </span>
<span class="mi">25</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="no">push</span><span class="w">   </span><span class="nv">%rbp</span><span class="w">               </span><span class="c1"># 入栈保存 %rbp</span>
<span class="err">26:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="nv">%rbp</span><span class="w">          </span><span class="c1"># 设置帧指针 %rbp</span>
<span class="err">29:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">83</span><span class="w"> </span><span class="nf">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="no">sub</span><span class="w">    </span><span class="no">$0x10</span><span class="p">,</span><span class="nv">%rsp</span><span class="w">         </span><span class="c1"># 分配16字节栈空间</span>
<span class="err">2</span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="nf">c7</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">f8</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="no">movq</span><span class="w">   </span><span class="no">$0x1</span><span class="p">,-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span><span class="w">    </span><span class="c1"># 将8字节金丝雀值写入栈</span>
<span class="err">34:</span><span class="w">   </span><span class="err">00</span><span class="w"> </span>
<span class="err">35:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">8</span><span class="nf">d</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="no">f8</span><span class="w">             </span><span class="no">lea</span><span class="w">    </span><span class="mi">-0</span><span class="no">x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># &amp;x</span>
<span class="err">39:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">c7</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rdi</span><span class="w">          </span><span class="c1"># 设置foo函数参数1为&amp;x</span>
<span class="err">3</span><span class="nl">c:</span><span class="w">   </span><span class="nf">e8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="no">callq</span><span class="w">  </span><span class="mh">41</span> <span class="p">&lt;</span><span class="no">bar</span><span class="p">+</span><span class="mi">0x20</span><span class="p">&gt;</span><span class="w">      </span><span class="c1"># 调用foo(&amp;x)</span>
<span class="err">41:</span><span class="w">   </span><span class="err">90</span><span class="w">                      </span><span class="nf">nop</span>
<span class="err">42:</span><span class="w">   </span><span class="nf">c9</span><span class="w">                      </span><span class="no">leaveq</span><span class="w"> </span>
<span class="mi">43</span><span class="p">:</span><span class="w">   </span><span class="no">c3</span><span class="w">                      </span><span class="no">retq</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">bar</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="_28">限制可执行代码区域<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>最后一招是消除攻击者向系统中插入可执行代码的能力。硬件支持多种形式的内存保护，能够指明用户程序和操作系统内核所允许的访问形式，包括：读、写和执行。栈可以被标记为可读和可写，但是不可执行，从而防止运行栈上的恶意代码。</p>
<h2 id="_29">其他<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<h3 id="_30">数据对齐<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>为了简化硬件设计，某种类型对象的地址必须是某个值K（通常时2、4或8）的倍数。</p>
<table>
<thead>
<tr>
<th>K</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>char</td>
</tr>
<tr>
<td>2</td>
<td>short</td>
</tr>
<tr>
<td>4</td>
<td>int, float</td>
</tr>
<tr>
<td>8</td>
<td>long, double, char*</td>
</tr>
</tbody>
</table>
<p>默认情况下，结构体数据对齐遵循两个原则：</p>
<ul>
<li>成员变量间需要添加空隙，使每个成员变量的地址自身对齐，即自身类型大小的倍数</li>
<li>结构体末尾需要添加空隙，使结构体大小为其最大成员变量大小的倍数，这样结构体的<strong>数组类型</strong>也能满足对齐要求</li>
</ul>
<p><code>#pragma pack(n)</code>命令指定对齐值后，有效对齐值=min{自身对齐值，当前指定的对齐值}，因此可以减少结构体的大小。</p>
<p><a href="https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/03/code/data_size">例子"data_size"</a>打印了不同结构体的大小：</p>
<p><div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">A</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">     </span><span class="c1">// 0</span>
<span class="w">    </span><span class="kt">short</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">    </span><span class="c1">// 2</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">      </span><span class="c1">// 4</span>
<span class="p">};</span><span class="w">              </span><span class="c1">// 8</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">B</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">     </span><span class="c1">// 0</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">      </span><span class="c1">// 4</span>
<span class="w">    </span><span class="kt">short</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">    </span><span class="c1">// 8</span>
<span class="p">};</span><span class="w">              </span><span class="c1">// 12</span>

<span class="cp">#pragma pack(2)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">C</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">     </span><span class="c1">// 0</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">      </span><span class="c1">// 2</span>
<span class="w">    </span><span class="kt">short</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">    </span><span class="c1">// 6</span>
<span class="p">};</span><span class="w">              </span><span class="c1">// 8</span>
<span class="cp">#pragma pack()</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">D</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">   </span><span class="c1">// 0</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">     </span><span class="c1">// 8</span>
<span class="p">};</span><span class="w">              </span><span class="c1">// 16</span>

<span class="cp">#pragma pack(4)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">E</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">   </span><span class="c1">// 0</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">     </span><span class="c1">// 8</span>
<span class="p">};</span><span class="w">              </span><span class="c1">// 12</span>
<span class="cp">#pragma pack()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&gt;./main
size<span class="w"> </span>class<span class="w"> </span>A:<span class="w"> </span><span class="m">8</span>
size<span class="w"> </span>class<span class="w"> </span>B:<span class="w"> </span><span class="m">12</span>
size<span class="w"> </span>class<span class="w"> </span>C:<span class="w"> </span><span class="m">8</span>
size<span class="w"> </span>class<span class="w"> </span>D:<span class="w"> </span><span class="m">16</span>
size<span class="w"> </span>class<span class="w"> </span>E:<span class="w"> </span><span class="m">12</span>
</code></pre></div></p>









  




                

  <!-- Giscus https://giscus.app/ -->
  <script src="https://giscus.app/client.js"
    data-repo="LittleBee1024/learning_book"
    data-repo-id="R_kgDOGR3spQ"
    data-category="Q&A"
    data-category-id="DIC_kwDOGR3spc4B_q-C"
    data-mapping="title"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
  </script>

  <!-- Reload on palette change -->
  <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") 
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 - 2022 Little Bee
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/littlebee1024" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/littlebee1024" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:littlebee1024@outlook.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>