# 优化后的二进制

> [《高效C/C++调试》 - 严琦](http://www.tup.tsinghua.edu.cn/Wap/tsxqy.aspx?id=10204101)，第五章的读书笔记，本文中的所有代码可在[GitHub仓库](https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/cpp_debug/05/code)中找到


## 调试版和发行版的区别

调试版和发行版的具体区别如下：

* 内存分配算法不同
    * Windows调试版可能分配比发行版更多的字节，从而掩盖了用户内存溢出的问题
* 由于条件编译导致执行语句的不同
    * 例如，`assert`语句就只在调试版中生效
* 局部变量和函数参数的存储位置可能会有所不同
    * 优化器会尽可能地利用寄存器，而调试版总会为局部变量和参数分配栈内存
    * 例如，对于未初始化变量仅发行版中存在问题，原因可能是，在调试版中该变量存在栈上，而发行版中存在寄存器中。栈上未初始化的内存可能是一个可以容忍的数值，而寄存器中原先的值更加随机，因而更容易发现问题
* 优化器会优化代码执行
    * 对于比较激进的优化器，有时可能会因改变了代码执行顺序，而产生不期望的结果

## 调试优化代码的挑战

调试优化程序最具挑战性的部分可能是**检查局部变量和函数参数的值**。根据函数的复杂程度、优化级别的选择和编译器的特定实现，调试器可能在某些上下文中拒绝显示某些局部变量的值或打印处完全错误的值。它与优化器放置局部变量的位置以及它们在程序运行时如何更新有很大关系：

* 优化后的程序不一定每次都更新局部变量在内存中的值(有可能在寄存器间操作)，导致内存位置不反应当前位置的值
* 由于执行顺序的优化，导致局部变量的修改时间可能和源代码不一致
* 没有任何副作用的局部变量可能被优化器删除

与局部变量和函数参数不同，全局变量不会受到优化的任何影响，因为全局变量具有固定的内存位置。

无论是发行版还是调试版，都建议总是打开生成调试符号的编译选项，即`-g`编译选项。

## 汇编代码介绍


