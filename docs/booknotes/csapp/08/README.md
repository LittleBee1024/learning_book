# 异常流控制

> [《深入理解计算机系统》 - Randal E. Bryant - 第三版](https://1drv.ms/b/s!AkcJSyT7tq80bJdqo_mT5IeFTsg?e=W297XG)，第八章的读书笔记，本文中的所有代码可在[GitHub仓库](https://github.com/LittleBee1024/learning_book/tree/main/docs/booknotes/csapp/08/code)中找到


异常控制流(Exceptional Control Flow, ECF)表示由非常规程序指令(`ret`，`call`等)触发的控制权跳转，其发生在计算机系统的各个层次：

* 硬件层 - 异常
    * 硬件检测的事件会触发控制突然转移到异常处理程序
* 操作系统层 - 系统调用
    * 内核通过上下文切换将控制从一个用户进程转移到另一个用户进程
* 应用层 - 信号
    * 信号接收进程接收到信号后，会将控制突然转移到它的一个信号处理程序

## 异常

异常是控制流中的突变，一部分由硬件实现，一部分由操作系统实现。异常发生的过程如下：

* 处理器检测到有事件发生
* 根据事件种类，从**异常表**中选择对应的异常处理程序地址，并进行跳转
* 当异常处理程序完成后，根据异常类型，会发生以下3种情况：
    * 将控制返回给当前指令，即当事件发生时正在执行的指令
    * 将控制返回给下一条指令，即没有发生异常将会执行的下一条指令
    * 终止被终端的程序

异常跳转的过程类似于过程调用，但也有一些不同之处：

* 异常跳转的返回地址会根据异常类型不同而不同，可能是当前指令，也可能是下一条指令
* 处理器也会保存现场，但如果控制是从用户程序转移到内核，所有这些项目都被压到内核栈，而不是压到用户栈

### 异常的类别

| 类别 | 原因 | 异步/同步 | 返回行为 |
| --- | --- | --- | --- |
| 中断 | 来自I/O设备的信号 | 异步 | 总是返回到下一条指令 |
| 陷阱 | 有意的异常，如系统调用 | 同步 | 总是返回到下一条指令 |
| 故障 | 潜在可恢复的错误 | 同步 | 可能返回到当前指令 |
| 终止 | 不可恢复的错误 | 同步 | 不会返回 |

中断是来自处理器外部的I/O设备的信号的结果，是异步的。除了中断，剩下的异常类型都是同步发生的，是执行当前指令的结果。

### Linux/x86-64系统种的异常


